services:
  service-a:
    container_name: service-a
    build: ./services/service-a
    env_file:
      - ./services/service-a/.env
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.http.routers.service-a.rule=PathPrefix(`/api/a`)
      - traefik.http.routers.service-a.entrypoints=web
      - traefik.http.routers.service-a.middlewares=service-a-strip
      - traefik.http.middlewares.service-a-strip.stripprefix.prefixes=/api/a
      - traefik.http.services.service-a.loadbalancer.server.port=3001
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 128M
        reservations:
          cpus: "0.2"
          memory: 64M

  service-b:
    container_name: service-b
    build: ./services/service-b
    env_file:
      - ./services/service-b/.env
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.http.routers.service-b.rule=PathPrefix(`/api/b`)
      - traefik.http.routers.service-b.entrypoints=web
      - traefik.http.routers.service-b.middlewares=service-b-strip
      - traefik.http.middlewares.service-b-strip.stripprefix.prefixes=/api/b
      - traefik.http.services.service-b.loadbalancer.server.port=3002
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 128M
        reservations:
          cpus: "0.2"
          memory: 64M

  service-c:
    container_name: service-c
    build: ./services/service-c
    env_file:
      - ./services/service-c/.env
    depends_on:
      service-a:
        condition: service_healthy
      service-b:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.http.routers.frontend.rule=PathPrefix(`/`)
      - traefik.http.routers.frontend.entrypoints=web
      - traefik.http.services.frontend.loadbalancer.server.port=5173
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 128M

  service-d:
    container_name: service-d
    build: ./services/service-d
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - DOCKER_HOST=unix:///var/run/docker.sock
    restart: unless-stopped
    labels:
      - traefik.enable=true
      - traefik.http.routers.netdata.rule=PathPrefix(`/netdata`)
      - traefik.http.routers.netdata.entrypoints=web
      - traefik.http.services.netdata.loadbalancer.server.port=19999
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 256M
        reservations:
          cpus: "0.2"
          memory: 128M

  service-e:
    container_name: service-e
    build: ./services/service-e
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 64M
        reservations:
          cpus: "0.1"
          memory: 32M
